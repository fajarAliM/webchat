<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>Web Chat</title>
    <script src="https://unpkg.com/core-js@2.6.3/client/core.min.js"></script>
    <script src="https://unpkg.com/simple-update-in@2.0.2/dist/simple-update-in.production.min.js"></script>
    <script src="https://unpkg.com/botframework-directlinejs@0.11.4/directLine.js"></script>
    <style>
      html, body { height: 100% }
      body { margin: 0 }

      #webchat {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="webchat" role="main"></div>
    <script>
      (async function () {
        const {
          DirectLine: { DirectLine },
          simpleUpdateIn: updateIn
        } = window;

        const urlSearchParams = new URLSearchParams(location.search);
        let version = urlSearchParams.get('v');
        const method = urlSearchParams.get('m') || 'remove';

        function createElement(tagName, attributes, ...children) {
          const element = document.createElement(tagName);

          Object.keys(attributes).forEach(name => {
            const value = attributes[name];

            if (/^on[A-Z]/.test(name)) {
              element.addEventListener(name.substr(2).toLowerCase(), value.bind(element));
            } else if (name === 'style') {
              const styles = value;
              const elementStyle = element.style;

              Object.keys(styles).forEach(name => {
                elementStyle[name] = styles[name];
              });
            } else if (typeof value === 'boolean') {
              value && element.setAttribute(name, '');
            } else if (typeof value !== 'undefined') {
              element.setAttribute(name, value);
            }
          });

          const childrenFragment = document.createDocumentFragment();

          children.forEach(child => childrenFragment.appendChild(typeof child === 'string' ? document.createTextNode(child) : child));
          element.appendChild(childrenFragment);

          return element;
        }

        function loadScript(src, integrity) {
          return new Promise((resolve, reject) => {
            document.head.appendChild(createElement(
              'script',
              {
                async: true,
                crossOrigin: 'anonymous',
                integrity,
                onError: reject,
                onLoad: resolve,
                src
              }
            ));
          });
        }

        function loadStylesheet(href, integrity) {
          document.head.appendChild(createElement(
            'link',
            {
              crossOrigin: 'anonymous',
              href,
              integrity,
              rel: 'stylesheet'
            }
          ));
        }

        async function loadAsset(src) {
          const [assetURL, integrity] = Array.isArray(src) ? src : [src, undefined];

          return /\.css$/i.test(assetURL) ? loadStylesheet(assetURL, integrity) : await loadScript(assetURL, integrity);
        }

        function passThru(observable, modifier) {
          return new Observable(observer => {
            const subscription = observable.subscribe({
              complete: () => observer.complete(),
              error: err => observer.error(err),
              next: value => {
                const nextValue = modifier ? modifier(value) : value;

                nextValue && observer.next(nextValue);
              }
            });

            return () => subscription.unsubscribe();
          });
        }

        const res = await fetch('https://webchat-mockbot.azurewebsites.net/directline/token', { method: 'POST' });
        const { token, userID } = await res.json();

        const VERSIONS = {
          '4.3': [['https://cdn.botframework.com/botframework-webchat/4.3.0/webchat.js']],
          '3': [
            ['https://unpkg.com/botframework-webchat@legacy/botchat.js'],
            ['https://unpkg.com/botframework-webchat@legacy/botchat.css']
          ],
          '0.15.0': [
            ['https://unpkg.com/botframework-webchat@0.15.0/botchat.js'],
            ['https://unpkg.com/botframework-webchat@0.15.0/botchat.css']
          ],
          '0.14.2': [
            ['https://unpkg.com/botframework-webchat@0.14.2/botchat.js'],
            ['https://unpkg.com/botframework-webchat@0.14.2/botchat.css']
          ],
          '0.13.1': [
            ['https://unpkg.com/botframework-webchat@0.13.1/botchat.js'],
            ['https://unpkg.com/botframework-webchat@0.13.1/botchat.css']
          ],
          '0.12.1': [
            ['https://unpkg.com/botframework-webchat@0.12.1/botchat.js'],
            ['https://unpkg.com/botframework-webchat@0.12.1/botchat.css']
          ],
          '0.11.4': [
            ['https://unpkg.com/botframework-webchat@0.11.4/botchat.js'],
            ['https://unpkg.com/botframework-webchat@0.11.4/botchat.css']
          ],
          '0.10.8': [
            ['https://unpkg.com/botframework-webchat@0.10.8/botchat.js'],
            ['https://unpkg.com/botframework-webchat@0.10.8/botchat.css']
          ],
          '0.9.1': [
            ['https://unpkg.com/botframework-webchat@0.9.1/botchat.js'],
            ['https://unpkg.com/botframework-webchat@0.9.1/botchat.css']
          ],
          '0.7.1': [
            ['https://unpkg.com/botframework-webchat@0.7.1/botchat.js'],
            ['https://unpkg.com/botframework-webchat@0.7.1/botchat.css']
          ],
          '0.4.1': [
            ['https://unpkg.com/botframework-webchat@0.4.1/botchat.js'],
            ['https://unpkg.com/botframework-webchat@0.4.1/botchat.css']
          ],
          'ibiza': [
            ['https://unpkg.com/botframework-webchat@ibiza/botchat.js'],
            ['https://unpkg.com/botframework-webchat@ibiza/botchat.css']
          ]
        };

        let assetURLs = VERSIONS[version];

        if (!assetURLs) {
          assetURLs = VERSIONS['4.3'];
          version = '4.3';
        }

        await Promise.all(assetURLs.map(url => loadAsset(url)));

        const directLine = new DirectLine({ token, webSocket: true });
        const quirkyDirectLine = {
          activity$: passThru(directLine.activity$, activity => {
            const nextActivity = updateIn(
              activity,
              ['attachments', () => true, 'contentUrl'],
              method === 'noop' ?
                value => value
              : method === 'placeholder' ?
                () => 'placeholder.png'
              : method === '403' ?
                // Removing the token will cause 403
                value => value.replace(/\?t=.+/, '')
              :
                undefined
            );

            console.log(nextActivity);

            return nextActivity;
          }),
          connectionStatus$: passThru(directLine.connectionStatus$),
          end: () => directLine.end(),
          get referenceGrammarId() { return directLine.referenceGrammarId; },
          getSessionId: (...args) => directLine.getSessionId(...args),
          postActivity: (...args) => directLine.postActivity(...args),
          get token() { return directLine.token; }
        };

        if (/^4/.test(version)) {
          window.WebChat.renderWebChat({
            directLine: quirkyDirectLine
          }, document.getElementById('webchat'));
        } else {
          window.BotChat.App({
            directLine: quirkyDirectLine,
            user: { id: userID, name: 'You' }
          }, document.getElementById('webchat'));
        }

        document.querySelector('#webchat > *').focus();

        setTimeout(() => {
          quirkyDirectLine.postActivity({
            from: { id: userID },
            text: `echo Loading Web Chat "${ version }" using method "${ method }"`,
            type: 'message'
          }).subscribe();
        }, 2000);
      })().catch(err => console.error(err));
    </script>
  </body>
</html>
