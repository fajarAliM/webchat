<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>Web Chat</title>
    <script src="https://unpkg.com/core-js@2.6.3/client/core.min.js"></script>
    <script src="https://unpkg.com/simple-update-in@2.0.2/dist/simple-update-in.production.min.js"></script>
    <script src="https://unpkg.com/react@16.8.6/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16.8.6/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.4.4/babel.min.js"></script>
    <style>
      html, body { height: 100% }
      body {
        background-color: #F7F7F7;
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        margin: 0
      }

      pre {
        margin-bottom: 1.5em;
      }

      #root {
        height: 100%;
        width: 100%;
      }

      label > span:first-child {
        display: inline-block;
        width: 100px;
      }
    </style>
  </head>
  <body>
    <div id="root" role="main"></div>
    <div style="position: absolute; right: 0; top: 0">
      <a href="https://github.com/compulim/webchat-loader">
        <img width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_gray_6d6d6d.png?resize=149%2C149" alt="Fork me on GitHub">
      </a>
    </div>
    <script type="text/babel">
    'use strict';

    (async function () {
      const { useEffect, useMemo, useState } = React;

      function generateUserId() {
        return `dl_${ Math.random().toString(36).substr(2) }`;
      }

      async function generateDirectLineToken(secret) {
        const userId = generateUserId();

        const res = await fetch(`https://directline.botframework.com/v3/directline/tokens/generate`, {
          body: JSON.stringify({ User: { Id: userId } }),
          headers: {
            authorization: `Bearer ${ secret }`,
            'Content-Type': 'application/json'
          },
          method: 'POST'
        });

        if (!res.ok) {
          throw new Error(`Direct Line returned ${ res.status } while generating token`);
        }

        const json = await res.json();

        if ('error' in json) {
          throw new Error(`Direct Line responded ${ JSON.stringify(json.error) } while generating new token`);
        }

        return { ...json, userId };
      }

      const VersionSelector = ({
        onChange,
        value
      }) => {
        const [versions, setVersions] = useState([]);

        useMemo(async () => {
          const res = await fetch(`https://bypasscors.herokuapp.com/api/?url=${ encodeURIComponent('https://registry.npmjs.org/botframework-webchat/') }`);
          const json = await res.json();
          const { time, versions } = json;
          const sortedVersions = Object.values(versions).sort((x, y) => {
            x = new Date(time[x.version]);
            y = new Date(time[y.version]);

            return x > y ? -1 : x < y ? 1 : 0;
          }).map(version => ({
            ...version,
            time: time[version.version]
          }));

          setVersions(sortedVersions);
        }, []);

        const presetVersions = {
          '4.4.1': '4.4.1',
          '4.3.0': '4.3.0',
          '4.2.0': '4.2.0',
          '4.1.0': '4.1.0',
          v3: versions.map(({ version }) => version).find(version => /-v3\./.test(version)),
          scorpio: versions.map(({ version }) => version).find(version => /-ibiza\./.test(version))
        };

        return (
          <p>
            <label style={{
              alignItems: 'flex-start',
              display: 'flex'
            }}>
              <span>Version</span>
              <div>
                <div>
                  <select
                    onChange={ ({ target: { value } }) => onChange(value) }
                    value={ value }
                  >
                    { versions.map(({ time, version }) =>
                      <option value={ version }>
                        { version } ({ new Date(time).toLocaleDateString() })
                      </option>
                    ) }
                  </select>
                </div>
                <div>
                  {
                    Object.keys(presetVersions).map(name =>
                      <a
                        href="#"
                        onClick={ evt => {
                          evt.preventDefault();
                          onChange(presetVersions[name]);
                        } }
                        style={{ marginRight: '.5em' }}
                      >
                        { name }
                      </a>
                    )
                  }
                </div>
              </div>
            </label>
          </p>
        );
      };

      const Credential = ({
        onSecretChange,
        onTokenChange,
        onUserIdChange,
        secret,
        token,
        userId
      }) => {
        useMemo(async () => {
          const { token, userId } = await generateDirectLineToken(secret);
          // const res = await fetch('https://webchat-mockbot.azurewebsites.net/directline/token', { method: 'POST' });
          // const { token, userID } = await res.json();
        }, [secret]);

        return (
          <React.Fragment>
            <p>
              <label>
                <span>{ token ? 'Token' : 'Secret' }</span>
                <input
                  onChange={ token ? undefined : ({ target: { value } }) => onSecretChange(value) }
                  onFocus={ ({ target }) => target.select() }
                  readOnly={ !!token }
                  style={{ fontFamily: `Consolas, 'Courier New', monospace`, marginRight: '1em' }}
                  value={ token || secret }
                />
                {
                  token ?
                    <button
                      onClick={ () => {
                        onTokenChange('');
                        onUserIdChange(`r_${ Math.random().toString(36).substr(2) }`);
                      } }
                      type="button"
                    >
                      Use secret
                    </button>
                  :
                    <button
                      onClick={ async () => {
                        const { token, userId } = await generateDirectLineToken(secret);

                        onTokenChange(token);
                        onUserIdChange(userID);
                      } }
                      type="button"
                    >
                      Generate token
                    </button>
                }
              </label>
            </p>
            <p>
              <label>
                <span>User ID</span>
                <input
                  readOnly={ true }
                  style={{ fontFamily: `Consolas, 'Courier New', monospace` }}
                  value={ userId }
                />
              </label>
            </p>
          </React.Fragment>
        );
      };

      const ExperimentSelector = ({
        onChange,
        value
      }) =>
        <p>
          <label>
            <span>Experiment</span>
            <select
              onChange={ ({ target: { value } }) => onChange(value) }
              value={ value }
            >
              <option value="">No experiments</option>
              <option value="remove">Remove content URL</option>
              <option value="placeholder">Replace content URL with a placeholder image</option>
              <option value="403">Replace content URL with one return 403</option>
            </select>
          </label>
        </p>

      const WebSocketToggle = ({
        onChange,
        value
      }) =>
        <p>
          <label>
            <span>Web Socket</span>
            <input
              checked={ value }
              onChange={ ({ target: { checked } }) => onChange(checked) }
              style={{ margin: 0 }}
              type="checkbox"
            />
          </label>
        </p>

      const App = () => {
        const [experiment, setExperiment] = useState('');
        const [secret, setSecret] = useState(localStorage.getItem('WEB_CHAT_SECRET') || '');
        const [token, setToken] = useState('');
        const [userId, setUserId] = useState(`r_${ Math.random().toString(36).substr(2) }`);
        const [version, setVersion] = useState('4.4.1');
        const [useWebSocket, setUseWebSocket] = useState(true);
        const searchParams = new URLSearchParams({
          ...(experiment ? { x: experiment } : {}),
          v: version,
          ...(token ? { t: token } : { s: secret }),
          userid: userId,
          ws: useWebSocket + ''
        });
        const webChatURL = `webchat?${ searchParams.toString() }`;

        localStorage.setItem('WEB_CHAT_SECRET', secret);

        return (
          <div
            style={{
              alignItems: 'center',
              display: 'flex',
              flexDirection: 'column',
              height: '100%',
              justifyContent: 'center'
            }}
          >
            <div style={{
              backgroundColor: 'White',
              border: 'solid 1px #DDD',
              padding: '0 20px 20px'
            }}>
              <pre>&nbsp;_       __     __       ________          __<br />
                | |     / /__  / /_     / ____/ /_  ____ _/ /_<br />
                | | /| / / _ \/ __ \   / /   / __ \/ __ `/ __/<br />
                | |/ |/ /  __/ /_/ /  / /___/ / / / /_/ / /_<br />
                |__/|__/\___/_.___/   \____/_/ /_/\__,_/\__/<br />
              </pre>
              <VersionSelector
                onChange={ setVersion }
                value={ version }
              />
              <Credential
                onSecretChange={ setSecret }
                onTokenChange={ setToken }
                onUserIdChange={ setUserId }
                secret={ secret }
                token={ token }
                userId={ userId }
              />
              <WebSocketToggle
                onChange={ setUseWebSocket }
                value={ useWebSocket }
              />
              <ExperimentSelector
                onChange={ setExperiment }
                value={ experiment }
              />
              <p style={{ marginBottom: 0 }}>
                <a
                  href={ webChatURL }
                  target="_blank"
                >
                  Open Web Chat in a new window
                </a>
              </p>
            </div>
          </div>
        );
      };

      ReactDOM.render(<App />, document.getElementById('root'));
    })().catch(err => console.error(err));
    </script>
  </body>
  <!--
    Slant by Glenn Chappell 3/93 -- based on Standard
    Includes ISO Latin-1
    figlet release 2.1 -- 12 Aug 1994
    Permission is hereby given to modify this font, as long as the
    modifier's name is placed on a comment line.

    Modified by Paul Burton <solution@earthlink.net> 12/96 to include new parameter
    supported by FIGlet and FIGWin.  May also be slightly modified for better use
    of new full-width/kern/smush alternatives, but default output is NOT changed.
  -->
</html>
