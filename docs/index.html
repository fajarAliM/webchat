<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>Web Chat Loader</title>
    <script src="https://unpkg.com/core-js@2.6.3/client/core.min.js"></script>
    <script src="https://unpkg.com/simple-update-in@2.0.2/dist/simple-update-in.production.min.js"></script>
    <script src="https://unpkg.com/react@16.8.6/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16.8.6/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.4.4/babel.min.js"></script>
    <style>
      html, body { height: 100% }
      body {
        background-color: #F7F7F7;
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        margin: 0
      }

      pre {
        margin-bottom: 1.5em;
      }

      #root {
        height: 100%;
        width: 100%;
      }

      label > span:first-child {
        display: inline-block;
        width: 100px;
      }
    </style>
  </head>
  <body>
    <div id="root" role="main"></div>
    <div style="position: absolute; right: 0; top: 0">
      <a href="https://github.com/compulim/webchat-loader">
        <img width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_gray_6d6d6d.png?resize=149%2C149" alt="Fork me on GitHub">
      </a>
    </div>
    <script type="text/babel">
    'use strict';

    (async function () {
      const { useCallback, useEffect, useMemo, useState } = React;

      function generateUserId() {
        return `dl_${ Math.random().toString(36).substr(2) }`;
      }

      async function generateDirectLineToken(secret) {
        const userId = generateUserId();

        const res = await fetch(`https://directline.botframework.com/v3/directline/tokens/generate`, {
          body: JSON.stringify({ User: { Id: userId } }),
          headers: {
            authorization: `Bearer ${ secret }`,
            'Content-Type': 'application/json'
          },
          method: 'POST'
        });

        if (!res.ok) {
          throw new Error(`Direct Line returned ${ res.status } while generating token`);
        }

        const json = await res.json();

        if ('error' in json) {
          throw new Error(`Direct Line responded ${ JSON.stringify(json.error) } while generating new token`);
        }

        return { ...json, userId };
      }

      const VersionSelector = ({
        onChange,
        value
      }) => {
        const [versions, setVersions] = useState([]);

        useMemo(async () => {
          try {
            const res = await fetch('https://webchat-mockbot.azurewebsites.net/versions/botframework-webchat');

            setVersions((await res.json()).versions);
          } catch (err) {
            if (err) {
              return alert('Failed to fetch version list from NPMJS. Please check network trace for details.');
            }
          }
        }, []);

        const style = useMemo(() => ({ fontSize: '80%', marginRight: '.5em' }));

        const presetVersions = {
          '4.4.2': '4.4.2',
          '4.4.1': '4.4.1',
          '4.3.0': '4.3.0',
          '4.2.0': '4.2.0',
          '4.1.0': '4.1.0',
          v3: (versions || []).map(({ version }) => version).find(version => /-v3\./.test(version)),
          scorpio: (versions || []).map(({ version }) => version).find(version => /-ibiza\./.test(version)),
          'localhost:5000': 'localhost'
        };

        return (
          <p>
            <label style={{
              alignItems: 'flex-start',
              display: 'flex'
            }}>
              <span>Version</span>
              <div>
                <div>
                  <select
                    disabled={ !versions }
                    onChange={ ({ target: { value } }) => onChange(value) }
                    value={ value }
                  >
                    { (versions || []).map(({ time, version }) =>
                      <option value={ version }>
                        { version } ({ new Date(time).toLocaleDateString() })
                      </option>
                    ) }
                    <option value="localhost">http://localhost:5000/webchat.js</option>
                  </select>
                </div>
                <div>
                  {
                    Object.keys(presetVersions).map((name, index) =>
                      <a
                        href="#"
                        onClick={ evt => {
                          evt.preventDefault();
                          onChange(presetVersions[name]);
                        } }
                        style={ style }
                      >
                        { name }
                      </a>
                    )
                  }
                </div>
              </div>
            </label>
          </p>
        );
      };

      const Credential = ({
        onSecretChange,
        onTokenChange,
        onUserIdChange,
        secret,
        token,
        userId
      }) => {
        useMemo(async () => {
          const { token, userId } = await generateDirectLineToken(secret);
          // const res = await fetch('https://webchat-mockbot.azurewebsites.net/directline/token', { method: 'POST' });
          // const { token, userID } = await res.json();
        }, [secret]);

        const handleFocus = useCallback(({ target }) => target.select());
        const handleSecretChange = useCallback(({ target: { value } }) => onSecretChange(value), [onSecretChange, token]);
        const presetStyle = useMemo(() => ({ fontFamily: `Consolas, 'Courier New', monospace`, marginRight: '1em' }));
        const userIdStyle = useMemo(() => ({ fontFamily: `Consolas, 'Courier New', monospace` }));

        return (
          <React.Fragment>
            <p>
              <label>
                <span>{ token ? 'Token' : 'Secret' }</span>
                <input
                  onChange={ token ? undefined : handleSecretChange }
                  onFocus={ handleFocus }
                  readOnly={ !!token }
                  style={ presetStyle }
                  value={ token || secret }
                />
                {
                  token ?
                    <button
                      onClick={ () => {
                        onTokenChange('');
                        onUserIdChange(`r_${ Math.random().toString(36).substr(2) }`);
                      } }
                      type="button"
                    >
                      Use secret
                    </button>
                  :
                    <button
                      onClick={ async () => {
                        const { token, userId } = await generateDirectLineToken(secret);

                        onTokenChange(token);
                        onUserIdChange(userId);
                      } }
                      type="button"
                    >
                      Generate token
                    </button>
                }
              </label>
            </p>
            <p>
              <label>
                <span>User ID</span>
                <input
                  onFocus={ handleFocus }
                  readOnly={ true }
                  style={ userIdStyle }
                  value={ userId }
                />
              </label>
            </p>
          </React.Fragment>
        );
      };

      const SpeechCredential = ({
        onSpeechKeyChange,
        speechKey
      }) => {
        const handleChange = useCallback(({ target: { value } }) => onSpeechKeyChange(value), [onSpeechKeyChange]);
        const handleFocus = useCallback(({ target }) => target.select());
        const style = useMemo(() => ({ fontFamily: `Consolas, 'Courier New', monospace`, marginRight: '1em' }));

        return (
          <p>
            <label>
              <span>Speech key</span>
              <input
                onChange={ handleChange }
                onFocus={ handleFocus }
                style={ style }
                value={ speechKey }
              />
            </label>
          </p>
        );
      }

      const ExperimentSelector = ({
        onChange,
        value
      }) => {
        const handleChange = useCallback(({ target: { value } }) => onChange(value));

        return (
          <p>
            <label>
              <span>Experiment</span>
              <select
                onChange={ handleChange }
                value={ value }
              >
                <option value="">No experiments</option>
                <option value="remove">Remove content URL</option>
                <option value="placeholder">Replace content URL with a placeholder image</option>
                <option value="403">Replace content URL with one return 403</option>
              </select>
            </label>
          </p>
        );
      }

      const WebSocketToggle = ({
        onChange,
        value
      }) => {
        const handleChange = useCallback(({ target: { checked } }) => onChange(checked), [onChange]);
        const style = useMemo(() => ({ margin: 0 }));

        return (
          <p>
            <label>
              <span>Web Socket</span>
              <input
                checked={ value }
                onChange={ handleChange }
                style={ style }
                type="checkbox"
              />
            </label>
          </p>
        );
      }

      const App = () => {
        const [experiment, setExperiment] = useState('');
        const [secret, setSecret] = useState(localStorage.getItem('WEB_CHAT_SECRET') || '');
        const [speechKey, setSpeechKey] = useState(localStorage.getItem('SPEECH_KEY') || '');
        const [token, setToken] = useState('');
        const [userId, setUserId] = useState(`r_${ Math.random().toString(36).substr(2) }`);
        const [useWebSocket, setUseWebSocket] = useState(true);
        const [version, setVersion] = useState('4.4.2');
        const searchParams = new URLSearchParams({
          ...(experiment ? { x: experiment } : {}),
          v: version,
          ...(token ? { t: token } : { s: secret }),
          ...(speechKey ? { speechkey: speechKey } : {}),
          userid: userId,
          ws: useWebSocket + ''
        });
        const webChatURL = `webchat?${ searchParams.toString() }`;

        useMemo(() => localStorage.setItem('SPEECH_KEY', speechKey), [speechKey]);
        useMemo(() => localStorage.setItem('WEB_CHAT_SECRET', secret), [secret]);

        return (
          <div
            style={{
              alignItems: 'center',
              display: 'flex',
              flexDirection: 'column',
              height: '100%',
              justifyContent: 'center'
            }}
          >
            <div style={{
              backgroundColor: 'White',
              border: 'solid 1px #DDD',
              padding: '0 20px 20px'
            }}>
              <pre>&nbsp;_       __     __       ________          __<br />
                | |     / /__  / /_     / ____/ /_  ____ _/ /_<br />
                | | /| / / _ \/ __ \   / /   / __ \/ __ `/ __/<br />
                | |/ |/ /  __/ /_/ /  / /___/ / / / /_/ / /_<br />
                |__/|__/\___/_.___/   \____/_/ /_/\__,_/\__/<br />
              </pre>
              <VersionSelector
                onChange={ setVersion }
                value={ version }
              />
              <Credential
                onSecretChange={ setSecret }
                onTokenChange={ setToken }
                onUserIdChange={ setUserId }
                secret={ secret }
                token={ token }
                userId={ userId }
              />
              <WebSocketToggle
                onChange={ setUseWebSocket }
                value={ useWebSocket }
              />
              <SpeechCredential
                onSpeechKeyChange={ setSpeechKey }
                speechKey={ speechKey }
              />
              <ExperimentSelector
                onChange={ setExperiment }
                value={ experiment }
              />
              <p style={{ marginBottom: 0 }}>
                <a
                  href={ webChatURL }
                  target="_blank"
                >
                  Open Web Chat in a new window
                </a>
              </p>
            </div>
          </div>
        );
      };

      ReactDOM.render(<App />, document.getElementById('root'));
    })().catch(err => console.error(err));
    </script>
  </body>
  <!--
    Slant by Glenn Chappell 3/93 -- based on Standard
    Includes ISO Latin-1
    figlet release 2.1 -- 12 Aug 1994
    Permission is hereby given to modify this font, as long as the
    modifier's name is placed on a comment line.

    Modified by Paul Burton <solution@earthlink.net> 12/96 to include new parameter
    supported by FIGlet and FIGWin.  May also be slightly modified for better use
    of new full-width/kern/smush alternatives, but default output is NOT changed.
  -->
</html>
